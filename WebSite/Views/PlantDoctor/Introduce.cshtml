
@{
    ViewBag.Title = "Introduce";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section HeadScript {
    @if (ICCModule.Helper.AppSettingHelper.Get_Debug_Mode())
    {
        <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    }
    else
    {
        <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    }
}

<style>
    .text-blue {
        color: blue;
        text-decoration: underline;
    }

    .text-red {
        color: red;
        text-decoration: underline;
    }

    .detail {
        font-family: 'Arial Negreta', 'Arial Normal', 'Arial';
        font-weight: 700;
    }

    .form-control.error {
        border-color: red;
        border-width: 2px;
        font-size: 1rem;
        width: 100%;
    }

    .form-inline .form-control.error {
        width: auto;
    }

    label.error {
        bottom: -30px;
        color: red;
        font-size: 14px;
        position: absolute;
    }

    .form-inline label.error {
        bottom: -20px;
    }

    .error-border {
        border-color: red;
        border-width: 2px;
    }

    .text-pp {
        color: #979898;
        width: 70px;
    }

    [v-cloak] {
        display: none;
    }
</style>

<div class="s-menu">
    <div class="container">
        <ul>
            <li><a href="~/Member/SignUp">會員註冊</a></li>
            <li><a href="~/PlantDoctor/Introduce">植醫掛號</a></li>
            <li><a href="~/Member/Manage">個人資料管理</a></li>
            <li><a href="~/PlantDoctor/RecordList">植醫輔導紀錄</a></li>
            <li><a href="~/Member/InventoryList">資材使用狀況</a></li>
            <li><a href="~/Member/Notify">疫情資訊訂閱</a></li>
        </ul>
    </div>
</div>

<section class="content bg-img">
    <div class="con-box">
        <div class="container">
            <div class="con-head">
                <div class="title d-flex justify-content-between pb-0 align-items-end">
                    <h3>
                        <span class="line">植物醫師線上掛號服務</span>
                    </h3>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="~/Member/SignUp">會員專區</a></li>
                            <li class="breadcrumb-item active" aria-current="page">植醫掛號</li>
                        </ol>
                    </nav>
                </div>
            </div>
            <div class="con-body">
                <div class="card">
                    <div class="card-body">
                        <div class="row detail">
                            <div class="mt-3">
                                一、線上預約植物醫師診斷掛號需請您先進行<span class="text-blue" style="cursor:pointer" data-toggle="modal" data-target="#LoginModal">會員註冊/登入</span>，完成後根據預約日期與時段進行線上掛號填單。
                            </div>
                            <div class="mt-3">
                                二、植物醫師診斷之作物類別<span class="text-red">以水稻、蔬菜、果樹等作物為主</span>，觀賞植物例如：龜背芋、盆栽等，請您聯繫<a href="https://www.tari.gov.tw/sub/content/index.asp?Parser=1,34,511,492" target="_blank">鳳山熱帶園藝試驗分所</a>協助。
                            </div>
                            <div class="mt-3">
                                三、線上掛號諮詢以電話、Line視訊為主，掛號資料可以上傳病徵照片、最近使用農藥照片，或是肥料照片，歡迎您先行備妥資料後再進行線上預約掛號。植物醫師若因臨時狀況取消您的預約，將會以簡訊方式通知您，不便之處，敬請見諒。
                            </div>
                            <div class="mt-3">
                                四、每人諮詢時間為30分鐘為限，提供上午9:30-12:00；下午14:30-16:00，場次預約名額，遲到10分鐘以上取消當日預約資格。預約未到滿3次，會暫停您1個月進行線上預約。但若有需求，您仍可到辦公室進行植物醫師問診。
                            </div>
                        </div>
                        <div style="margin-top:10vh;text-align:center">
                            <button type="button" class="btn btn-primary" onclick="location.href='/PlantDoctor/CounselingUnit'">我已詳細閱讀並且了解，進入植醫掛號畫面</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</section>

<!--會員登入Modal -->
<div class="modal fade" id="LoginModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header" style="border-bottom:none">
                @*<div class="title d-flex justify-content-between pb-0 align-items-end">
                        <h3 style="display:inline-block" class="modal-title">
                            <span class="line">會員登入</span>
                        </h3>
                    </div>*@
                <div class="login" style="flex:auto">
                    <h3 class="title"><span class="line">會員登入</span><span class="tips">Login</span></h3>
                </div>
            </div>
            <div class="modal-body">
                <div class="login">
                    <form id="LoginForm" method="post">
                        @Html.AntiForgeryToken()
                        <div class="form-inline">
                            <span class="text-pp">帳號</span>
                            <div class="d-flex flex-column position-relative" style="flex: 1;">
                                <input type="text" name="LoginID" class="form-control" required v-model="LoginID">
                            </div>
                        </div>
                        <div class="form-inline mt-3">
                            <span class="text-pp">密碼</span>
                            <div class="d-flex flex-column position-relative" style="flex: 1;">
                                <input type="password" name="LoginPass" class="form-control" required v-model="LoginPass">
                            </div>
                        </div>
                        <div class="form-group mt-3">
                            <div class="form-inline" style="justify-content:flex-start">
                                <div class="d-flex flex-column position-relative">
                                    <input type="text" name="reCAPTCHA" class="form-control underlined mr-2" style="width: auto;" autocomplete="off" v-model="reCAPTCHA" required />
                                </div>
                                <figure class="m-2">
                                    <img id="verifyimage" src="/Home/GetValidateCodeImage" href="#" v-on:click="Refresh_ValidateCode" title="刷新驗證碼">
                                </figure>
                            </div>
                        </div>
                        <div>
                            <button type="submit" class="btn btn-warning btn-block" v-on:click.prev.stop="handleSubmit">登入</button>
                            <button type="button" class="btn btn-warning btn-block" data-dismiss="modal">取消</button>
                        </div>
                        <div class="d-flex justify-content-between">
                            <div class="form-check">
                                <input type="checkbox" name="RememberMe" class="form-check-input" id="RememberMeCheck" value="">
                                <label class="form-check-label" for="RememberMeCheck" style="padding-left: 1.2em;">記住我</label>
                            </div>
                            <ul class="login-list">
                                <li><a href="~/Member/SignUp">註冊會員</a></li>
                                <li><a href="~/Member/Forgot">忘記密碼？</a></li>
                            </ul>
                        </div>
                    </form>

                </div>
            </div>
        </div>
    </div>
</div>
@{ 
    string error = (TempData["error"] == null) ? "" : TempData["error"].ToString();
    TempData["error"] = null;
}
@section Script {
    <script type="text/javascript">
        $(document).ready(function () {
            const Intro = new Vue({
                el: '#LoginModal',
                data: {
                    error: '@(error)',
                    validator: null,
                    LoginID: null,
                    LoginPass: null,
                    reCAPTCHA: null
                },
                methods: {
                    reset() {
                        this.LoginID = null;
                        this.LoginPass = null;
                        this.reCAPTCHA = null;
                    },
                    handleSubmit() {
                        console.log('handleSubmit')
                        this.validator = $('#LoginForm').validate({
                            rules: {
                                "LoginID": {
                                    required: true
                                },
                                "LoginPass": {
                                    required: true
                                },
                                "reCAPTCHA": {
                                    required: true
                                },
                            },
                            messages: {
                                "LoginID": {
                                    required: "請輸入帳號"
                                },
                                "LoginPass": {
                                    required: "請輸入密碼"
                                },
                                "reCAPTCHA": {
                                    required: "請輸入驗證碼"
                                },
                            },
                            submitHandler: function (form) {
                                const self = this;
                                let data = $('#LoginForm').serializeArray().reduce(function (obj, item) {
                                    obj[item.name] = item.value;
                                    return obj;
                                }, {});

                                $.ajax({
                                    url: '/PlantDoctor/Login',
                                    data: Object.assign({
                                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                                    }, data),
                                    type: 'POST',
                                    cache: false,
                                    dataType: 'json',
                                    success: function (data) {
                                        Swal.fire({
                                            icon: data.result ? "info" : "error",
                                            title: data.Msg
                                        }).then(res => {
                                            if (data.result && res.isConfirmed) {
                                                $('#LoginModal').modal('hide');
                                                self.reset();
                                                self.Refresh_ValidateCode();
                                            }
                                        })
                                    }
                                })
                            }
                        });
                    },
                    //重新整理驗證碼
                    Refresh_ValidateCode() {
                        document.getElementById('verifyimage').src = '/Home/GetValidateCodeImage?' + Math.random();
                    }
                },
                mounted() {
                    if (this.error) {
                        Swal.fire({
                            icon: 'error',
                            title: this.error
                        });
                    }
                }
            });
        });
    </script>
}