@using Newtonsoft.Json;
@model InformationSystem.ViewModel.PlantDoctor.InfoListViewModel
@{
    string OriginName = String.Empty;
    switch (Model.Schedule.Origin.ToLower())
    {
        case "member":
            OriginName = "前台新增";
            break;
        case "plantdoctor":
            OriginName = "後台新增";
            break;
        case "drugtest":
            OriginName = "藥檢轉單";
            break;
        case "line":
            OriginName = "Line預約";
            break;
    }

    ViewBag.Title = "ViewTrans";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@Html.Partial("LeafletMapBasic")

@section HeadScript {
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    @if (ICCModule.Helper.AppSettingHelper.Get_Debug_Mode())
    {
        <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    }
    else
    {
        <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    }
}

<style>
    .form-control.error {
        border-color: red;
        border-width: 2px;
        font-size: 1rem;
        width: 100%;
    }

    .form-inline .form-control.error {
        width: auto;
    }

    .form-check-input.error {
        width: auto !important;
    }

    label.error {
        bottom: -30px;
        color: red;
        font-size: 14px;
        justify-content: flex-start;
        position: absolute;
    }

    .form-inline label.error {
        bottom: -20px;
    }

    .error-border {
        border-color: red;
        border-width: 2px;
    }

    .table thead th {
        text-align: right;
        vertical-align: middle !important;
    }

    .table td {
        vertical-align: middle !important;
    }

    #map {
        height: 400px;
    }
</style>

<div class="container-fluid" id="DoctorSchedule">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-success">代收轉案</h1>
    </div>
    <div class="row">
        <div class="col-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-white">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table mb-0 table-striped">
                                <thead class="thead-light">
                                    <tr>
                                        <th style="width: 18%;"></th>
                                        <th style="width: 26%;"></th>
                                        <th style="width: 18%;"></th>
                                        <th style="width: 38%;"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>來源</td>
                                        <td>@(OriginName)</td>
                                        <td>預約日期</td>
                                        <td>
                                            <div class="form-inline">
                                                <input name="Schedule.ReserveDatetimeStr" type="date" disabled="disabled" class="form-control mr-2"
                                                       v-bind:readonly="Schedule.Origin == 'member'" v-model="Schedule.ReserveDatetimeStr" />
                                                <select name="Schedule.ReserveTime" class="form-control" disabled="disabled" style="flex:auto"
                                                        v-bind:readonly="Schedule.Origin == 'member'" v-model="Schedule.ReserveTime" v-if="ReserveTimeList && ReserveTimeList.length > 0">
                                                    <option v-for="(r, i) in ReserveTimeList" v-bind:key="'ReserveTimeList_' + i" v-bind:value="r">{{ r }}</option>
                                                </select>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <span class="important">輔導單位</span>
                                        </td>
                                        <td>
                                            <select name="Schedule.OrgType" class="form-control" v-model="Schedule.OrgType" disabled="disabled">
                                                <option value="">請選擇</option>
                                                <option v-for="o in CounselingList" v-bind:key="o.Code" v-bind:value="o.Code">{{ o.Name }}</option>
                                            </select>
                                        </td>
                                        <td>
                                            <span class="important">輔導單位行政區</span>
                                        </td>
                                        <td>
                                            <div class="form-inline">
                                                <select class="form-control" style="width: 100px;" disabled="disabled">
                                                    <option>高雄市</option>
                                                </select>
                                                <div class="d-flex flex-column position-relative ml-2">
                                                    <select id="ddlOrgDistrict" name="Schedule.OrgDistrict" class="form-control" disabled="disabled" style="width: 100px;" v-model="Schedule.OrgDistrict">
                                                        <option value="">請選擇</option>
                                                        <option v-for="(s, i) in Districts" v-bind:key="s.Zip" v-bind:value="s.Zip">{{ s.Name }}</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <span v-bind:class="Schedule.OrgType == 'None' ? '' : 'important'">輔導單位名稱</span>
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column position-relative">
                                                <input disabled="disabled" type="text" name="Schedule.OrgName" class="form-control" v-model="Schedule.OrgName" maxlength="50" />
                                            </div>
                                        </td>
                                        <td>
                                            <span>
                                                <span class="important">植物醫師</span>
                                            </span>
                                        </td>
                                        <td>
                                            <select name="Schedule.LoginID" class="form-control" v-model="Schedule.LoginID" disabled="disabled">
                                                <option value="">請選擇</option>
                                                <option v-for="(s, i) in DoctorList" v-bind:key="s.LoginID" v-bind:value="s.LoginID">
                                                    {{ s.UserName }}
                                                </option>
                                            </select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <span class="important">問診方式</span>
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column position-relative">
                                                <select name="Schedule.Inquiry" class="form-control" v-model="Schedule.Inquiry" disabled="disabled">
                                                    <option value="">請選擇</option>
                                                    <option v-for="o in InquiryList" v-bind:key="o.Code" v-bind:value="o.Code">{{ o.Name }}</option>
                                                    <option value="Other">其他</option>
                                                </select>
                                            </div>
                                        </td>
                                        <td>藥檢不合格抽檢單位</td>
                                        <td>
                                            <select name="Schedule.UnqualifiedUnit" class="form-control" v-model="Schedule.UnqualifiedUnit" disabled="disabled">
                                                <option value="null">請選擇</option>
                                                <option v-for="o in DrugTestList" v-bind:key="o.Code" v-bind:value="o.Code">{{ o.Name }}</option>
                                                <option value="Other">其他</option>
                                            </select>
                                            <input name="Schedule.OtherUnit" class="form-control" disabled="disabled" v-model="Schedule.OtherUnit" v-if="Schedule.UnqualifiedUnit == 'Other'" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <span class="important">姓名</span>
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column position-relative">
                                                <input type="text" name="Schedule.Name" class="form-control" v-model="Schedule.Name" disabled="disabled" />
                                            </div>
                                        </td>
                                        <td>性別</td>
                                        <td>
                                            <select name="Schedule.Sexy" class="form-control" v-model="Schedule.Sexy" disabled="disabled">
                                                <option value="null">請選擇</option>
                                                <option value="M">男</option>
                                                <option value="F">女</option>
                                                @*<option value="O">第三性</option>*@
                                            </select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <span class="important">作物栽種行政區</span>
                                        </td>
                                        <td>
                                            <div class="form-inline">
                                                <select class="form-control" style="width: 100px;" disabled="disabled">
                                                    <option>高雄市</option>
                                                </select>
                                                <div class="d-flex flex-column position-relative ml-2" disabled="disabled">
                                                    <input type="hidden" name="Schedule.District" value="@Model.Schedule.District" id="hidDistrict" />
                                                    <select id="ddlDistrict" name="Schedule.Zip" class="form-control" style="width: 100px;" v-model="Schedule.Zip" v-on:change="setDistrict()">
                                                        <option value="">請選擇</option>
                                                        <option v-for="(s, i) in Districts" v-bind:key="s.Zip" v-bind:value="s.Zip">{{ s.Name }}</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="important">作物種類</span>
                                        </td>
                                        <td>
                                            <div class="form-inline">
                                                <div class="d-flex flex-column position-relative">
                                                    <select name="Schedule.CropType" class="form-control mr-2" style="flex:40%" v-model="Schedule.CropType" disabled="disabled">
                                                        <option value="">請選擇</option>
                                                        <option v-for="(s, i) in CropTypeList" v-bind:key="'CropType_' + s.ID" v-bind:value="s.Name">
                                                            {{ s.Name }}
                                                        </option>
                                                        <option value="Other">其他</option>
                                                    </select>
                                                </div>
                                                <div class="d-flex flex-column position-relative">
                                                    <select name="Schedule.CropName" class="form-control ml-2" style="flex:40%" v-model="Schedule.CropName" disabled="disabled">
                                                        <option value="">請選擇</option>
                                                        <option v-for="(s, i) in CropList" v-bind:key="'Crop_' + s.ID" v-bind:value="s.Name">{{ s.Name }}</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <span class="important">行動電話</span>
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column position-relative">
                                                <input type="text" class="form-control mr-2" name="Schedule.Mobile" disabled="disabled" placeholder="例：0911111111"
                                                       minlength="10" maxlength="10" pattern="[0-9]{10}" required v-model="Schedule.Mobile" />
                                            </div>
                                        </td>
                                        <td>
                                            <span class="important">栽種面積</span>
                                        </td>
                                        <td>
                                            <div class="form-inline">
                                                <div class="d-flex flex-column position-relative">
                                                    <input type="number" step="0.01" disabled="disabled" min="0.01" name="Schedule.PlantingArea" class="form-control mr-2" v-model="Schedule.PlantingArea" />
                                                </div>
                                                <span>公頃</span>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <span class="important">耕作方式</span>
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column position-relative">
                                                <div class="d-flex">
                                                    <div class="form-check form-check-inline" v-for="s in FarmingMethodList" v-bind:key="s.Code">
                                                        <input class="form-check-input" disabled="disabled" type="radio" name="Schedule.FarmingMethod" v-bind:id="s.Code" v-bind:value="s.Code" v-model="Schedule.FarmingMethod">
                                                        <label class="form-check-label" v-bind:for="s.Code">{{ s.Name }}</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="important">聯繫管道</span>
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column position-relative">
                                                <div class="">
                                                    <div class="form-check form-check-inline" v-for="s in ContactList" v-bind:key="s.Code">
                                                        <input class="form-check-input" type="checkbox" disabled="disabled"
                                                               name="Schedule.ContactMethodArr"
                                                               v-bind:value="s.Code"
                                                               v-on:change="changeCheckbox('ContactMethodArr', s.Code)"
                                                               v-bind:checked="Schedule.ContactMethodArr && Schedule.ContactMethodArr.includes(s.Code)">
                                                        <label class="form-check-label" v-bind:for="s.Code">{{ s.Name }}</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <span>發病位置（複選）</span>
                                        </td>
                                        <td colspan="3">
                                            <div class="form-check form-check-inline" v-for="s in OnsetLocationList" v-bind:key="s.Code">
                                                <input class="form-check-input" type="checkbox" disabled="disabled"
                                                       name="Schedule.OnsetLocationArr"
                                                       v-bind:id="s.Code"
                                                       v-bind:value="s.Code"
                                                       v-on:change="changeCheckbox('OnsetLocationArr', s.Code)"
                                                       v-bind:checked="Schedule.OnsetLocationArr && Schedule.OnsetLocationArr.includes(s.Code)">
                                                <label class="form-check-label" v-bind:for="s.Code">{{ s.Name }}</label>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <span class="important">諮詢內容</span>
                                        </td>
                                        <td colspan="3">
                                            <div class="d-flex flex-column position-relative">
                                                <textarea class="form-control" name="Schedule.Context" rows="5" v-model="Schedule.Context" disabled="disabled"></textarea>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <span>作物病徵<br />圖/影片上傳</span>
                                        </td>
                                        <td colspan="3">
                                            <div>
                                                @foreach (var item in Model.OldCropSymptomsFiles)
                                                {
                                                    <div id="of_@item.ID" style="margin-bottom:8px">
                                                        <input type="hidden" id="of_@item.ID" name="EditOldCropSymptomsFiles[]" value="@item.ID" />
                                                        @if (item.FileType.Contains("image"))
                                                        {
                                                            <img src="/UploadedFiles/PlantDoctor/@(Model.Schedule.ID)/CropSymptomsFiles/@(item.FileName)" width="300px" />
                                                        }
                                                        else
                                                        {
                                                            <video src="/UploadedFiles/PlantDoctor/@(Model.Schedule.ID)/CropSymptomsFiles/@(item.FileName)" width="300px" controls></video>
                                                        }
                                                    </div>
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <span>最近使用農藥/肥料<br />圖/影片上傳</span>
                                        </td>
                                        <td colspan="3">
                                            <div>
                                                @foreach (var item in Model.OldRecentlyFertilizerFiles)
                                                {
                                                    <div id="of_@item.ID" style="margin-bottom:8px">
                                                        <input type="hidden" id="of_@item.ID" name="EditOldRecentlyFertilizerFiles[]" value="@item.ID" />
                                                        @if (item.FileType.Contains("image"))
                                                        {
                                                            <img src="/UploadedFiles/PlantDoctor/@(Model.Schedule.ID)/RecentlyFertilizerFiles/@(item.FileName)" width="300px" />
                                                        }
                                                        else
                                                        {
                                                            <video src="/UploadedFiles/PlantDoctor/@(Model.Schedule.ID)/RecentlyFertilizerFiles/@(item.FileName)" width="300px" controls></video>
                                                        }
                                                    </div>
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <span>田區位置</span>
                                        </td>
                                        <td colspan="3">
                                            <div>
                                                <span>田區位置，可輸入地址進行定位 (亦可點擊地圖進行定位)</span>
                                            </div>
                                            <div class="form-inline mt-3">
                                                <input type="hidden" name="Schedule.FramLocation" v-bind:value="Schedule.FramLocation" />
                                                <input type="text" autocomplete="off" id="pac-input" disabled="disabled"
                                                       class="form-control mr-3"
                                                       style="min-width: 500px; max-width:40em;"
                                                       v-model="SearchLocation"
                                                       placeholder="請輸入地址後，點選地址" />
                                                <span class="ml-2" v-text="Schedule.FramLocation"></span>
                                            </div>
                                            <div class="mt-3">
                                                <div id="map"></div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <span>肥料/營養劑<br />（氮磷鉀比例、用量）</span>
                                        </td>
                                        <td>
                                            <textarea disabled="disabled" name="Schedule.FertilizerNutrient" class="form-control" rows="3" v-model="Schedule.FertilizerNutrient"></textarea>
                                        </td>
                                        <td>
                                            <span>殺菌劑</span>
                                        </td>
                                        <td>
                                            <textarea disabled="disabled" name="Schedule.Fungicide" class="form-control" rows="3" v-model="Schedule.Fungicide"></textarea>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <span>殺蟲（蟎）劑</span>
                                        </td>
                                        <td>
                                            <textarea disabled="disabled" name="Schedule.Insecticide" class="form-control" rows="3" v-model="Schedule.Insecticide"></textarea>
                                        </td>
                                        <td>
                                            <span>殺草劑</span>
                                        </td>
                                        <td>
                                            <textarea disabled="disabled" name="Schedule.Herbicide" class="form-control" rows="3" v-model="Schedule.Herbicide"></textarea>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <span>其他資材</span>
                                        </td>
                                        <td colspan="3">
                                            <textarea disabled="disabled" name="Schedule.OtherMedicines" class="form-control" rows="5" v-model="Schedule.OtherMedicines"></textarea>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <span class="important">耕作歷史</span>
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column position-relative">
                                                <div class="d-flex">
                                                    <div class="form-check form-check-inline position-relative" v-for="s in FarmingHistoryList" v-bind:key="s.Code">
                                                        <input disabled="disabled" class="form-check-input" type="radio" name="Schedule.FarmingHistory" v-bind:id="s.Code" v-bind:value="s.Code" v-model="Schedule.FarmingHistory">
                                                        <label class="form-check-label" v-bind:for="s.Code">{{ s.Name }}</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span>前期作物</span>
                                        </td>
                                        <td>
                                            <input disabled="disabled" type="text" name="Schedule.ContinuousCrop" maxlength="100" v-model="Schedule.ContinuousCrop" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <span>害物種類</span>
                                        </td>
                                        <td colspan="3">
                                            <div class="form-check form-check-inline" v-for="s in PestTypeList" v-bind:key="s.Code">
                                                <input class="form-check-input" type="checkbox" disabled="disabled"
                                                       name="Schedule.PestTypeArr"
                                                       v-bind:id="s.Code"
                                                       v-bind:value="s.Code"
                                                       v-on:change="changeCheckbox('PestTypeArr', s.Code)"
                                                       v-bind:checked="Schedule.PestTypeArr && Schedule.PestTypeArr.includes(s.Code)">
                                                <label class="form-check-label" v-bind:for="s.Code">{{ s.Name }}</label>
                                            </div>
                                            <div class="form-inline">
                                                <div class="form-check">
                                                    <input disabled="disabled" class="form-check-input" name="Schedule.PestTypeArr" id="OtherPestType" type="checkbox" value="Other" v-on:change="changeCheckbox('PestTypeArr', 'Other')" v-bind:checked="Schedule.PestTypeArr && Schedule.PestTypeArr.includes('Other')">
                                                    <label class="form-check-label" for="OtherPestType">
                                                        其他
                                                    </label>
                                                </div>
                                            </div>
                                            <div>
                                                <input disabled="disabled" type="text" name="Schedule.OtherPest" class="form-control" style="flex:auto" v-bind:disabled="!Schedule.PestTypeArr || !Schedule.PestTypeArr.includes('Other')" v-model="Schedule.OtherPest" />
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <span>診斷結果</span>
                                        </td>
                                        <td colspan="3">
                                            <textarea disabled="disabled" name="Schedule.ResultDiagnosis" class="form-control" rows="5" v-model="Schedule.ResultDiagnosis"></textarea>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <span>防治建議</span>
                                            <br />
                                            <a href="@Model.FrontPesticidesInfoUrl" target="_blank" class="btn btn-primary mt-2">查詢農藥</a>
                                        </td>
                                        <td colspan="3">
                                            <select disabled="disabled" name="Schedule.RecommendationCategory" class="form-control mb-3" style="width: 200px;" v-model="Schedule.RecommendationCategory">
                                                <option v-for="(s, i) in PreventionList" v-bind:key="s.Code" v-bind:value="s.Code">
                                                    {{ s.Name }}
                                                </option>
                                                <option value="Other">其他（可輸入備註）</option>
                                            </select>
                                            <textarea disabled="disabled" name="Schedule.Recommendation" class="form-control" rows="3" v-model="Schedule.Recommendation"></textarea>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <span class="important">後送診斷</span>
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column position-relative">
                                                <select disabled="disabled" name="Schedule.TransferDiagnosis" class="form-control" v-model="Schedule.TransferDiagnosis">
                                                    <option v-for="(s, i) in TransferList" v-bind:key="s.Code" v-bind:value="s.Code">
                                                        {{ s.Name }}
                                                    </option>
                                                </select>
                                            </div>
                                        </td>
                                        <td>
                                            <span>實際診斷日期</span>
                                        </td>
                                        <td style="position: relative;">
                                            <input type="date" name="Schedule.DateDiagnosisStr" disabled="disabled"
                                                   v-bind:min="DiagnosisMin"
                                                   class="form-control"
                                                   v-model="Schedule.DateDiagnosisStr" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <span class="important">狀態</span>
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column position-relative">
                                                <select name="Schedule.Status" class="form-control" v-model="Schedule.Status" disabled="disabled">
                                                    <option v-for="(s, i) in StatusList" v-bind:key="s.Code" v-bind:value="s.Code">
                                                        {{ s.Name }}
                                                    </option>
                                                </select>
                                            </div>
                                        </td>
                                        <td></td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <span>植醫備註</span>
                                        </td>
                                        <td colspan="3">
                                            <textarea disabled="disabled" name="Schedule.DoctorComment" class="form-control" rows="5" v-model="Schedule.DoctorComment"></textarea>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <span>轉案原因</span>
                                        </td>
                                        <td colspan="3">
                                            @Model.Schedule.TransReason
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <span>轉案備註</span>
                                        </td>
                                        <td colspan="3">
                                            @Model.Schedule.TransRemark
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            建立日期：@(Model.Schedule.CreatedAtStr) ，@(Model.Schedule.Creator)
                            <br />
                            更新日期：@(Model.Schedule.UpdatedAtStr + "，" + Model.Schedule.Updater)
                            <br />
                            @if (Model.Schedule.TransDate.HasValue || Model.Schedule.AcceptCaseDate.HasValue)
                            {
                                <span>轉案日期：@(Model.Schedule.TransDateStr + "，" + Model.Schedule.TransUser)</span>
                                <br />
                                <span>收案日期：@(Model.Schedule.AcceptCaseDate.HasValue ? (Model.Schedule.AcceptCaseDateStr + "，" + Model.Schedule.AcceptCaseUser):"")</span>
                                <br />
                            }
                            <div style="text-align:center">
                                <button type="button" class="btn btn-primary" onclick="location.href='/PlantDoctor/TransScheduleList'">回上一頁</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@{
    string Which_MAP = System.Configuration.ConfigurationManager.AppSettings["Which_MAP"];
    string APIKEY = String.Empty;
    switch (Which_MAP)
    {
        case "Google":
            APIKEY = System.Configuration.ConfigurationManager.AppSettings["MapApiKey"];
            break;
        case "TGOS":
            APIKEY = System.Configuration.ConfigurationManager.AppSettings["TGOS_Geocoding_APIKEY"];
            string APPID = System.Configuration.ConfigurationManager.AppSettings["TGOS_Geocoding_APPID"];
            break;
        case "ArcGIS":
            APIKEY = System.Configuration.ConfigurationManager.AppSettings["ArcGIS_APIKEY"];
            break;
    }
}

@section Script {

    <script type="text/javascript">
        $(document).ready(function () {
            const DoctorSchedule = new Vue({
                el: "#DoctorSchedule",
                data: {
                    token: $('input[name="__RequestVerificationToken"]').val(),
                    lastMonth: '@(Model.Schedule.ReserveDatetime < DateTime.Today)' ? '@(Model.Schedule.ReserveDatetime.ToString("yyyy-MM-dd"))': moment().add(-1, 'months').format('YYYY-MM-DD'),
                    DiagnosisMin:'@(Model.Schedule.ReserveDatetimeStr != null)' ? "@Model.Schedule.ReserveDatetimeStr" : "null",
                    today: moment().format('YYYY-MM-DD'),
                    OriginList: @(new HtmlString(JsonConvert.SerializeObject(Model.OriginList))),
                    ReserveTimeList: @(new HtmlString(JsonConvert.SerializeObject(Model.ReserveTimeList))),
                    InquiryList: @(new HtmlString(JsonConvert.SerializeObject(Model.InquiryList))),
                    CounselingList: @(new HtmlString(JsonConvert.SerializeObject(Model.CounselingList))),
                    DrugTestList: @(new HtmlString(JsonConvert.SerializeObject(Model.DrugTestList))),
                    Districts: @(new HtmlString(JsonConvert.SerializeObject(Model.Districts))),
                    CropTypes: @(new HtmlString(JsonConvert.SerializeObject(Model.CropTypes))),
                    FarmingMethodList: @(new HtmlString(JsonConvert.SerializeObject(Model.FarmingMethodList))),
                    OnsetLocationList: @(new HtmlString(JsonConvert.SerializeObject(Model.OnsetLocationList))),
                    FarmingHistoryList: @(new HtmlString(JsonConvert.SerializeObject(Model.FarmingHistoryList))),
                    EarlyCropsList: @(new HtmlString(JsonConvert.SerializeObject(Model.EarlyCropsList))),
                    PestTypeList: @(new HtmlString(JsonConvert.SerializeObject(Model.PestTypeList))),
                    PreventionList: @(new HtmlString(JsonConvert.SerializeObject(Model.PreventionList))),
                    TransferList: @(new HtmlString(JsonConvert.SerializeObject(Model.TransferList))),
                    StatusList: @(new HtmlString(JsonConvert.SerializeObject(Model.StatusList))),
                    DoctorList: @(new HtmlString(JsonConvert.SerializeObject(Model.DoctorList))),
                    Schedule: @(new HtmlString(JsonConvert.SerializeObject(Model.Schedule))),
                    ContactList: [
                        {
                            Code: 'Mobile',
                            Name: '行動電話'
                        },
                        {
                            Code: 'Email',
                            Name: 'Email'
                        },
                        {
                            Code: 'Line',
                            Name: 'Line'
                        },
                    ],
                    validator: null,
                    DisabledSubmit: true,
                    SearchLocation: '',
                    defaultCenter: [22.6307027, 120.3414354],
                    center: [],
                    map: null,
                    popup: L.popup(),
                    promptStr: '',
                    MakerIcon: L.icon({
                        iconUrl: @(new HtmlString(JsonConvert.SerializeObject(Url.Content("/Scripts/Leaflet/images/marker-icon-change.png")))),
                        iconSize: [42, 42],
                    }),
                    marker: null,
                    search: null,
                    APIKEY: "@APIKEY",
                    Which_MAP: @(new HtmlString(JsonConvert.SerializeObject(Which_MAP))),
                },
                watch: {
                    'Schedule.OrgType'(newVal) {
                        if (this.validator) {
                            this.validator.resetForm();
                        }
                        if (newVal == "None") {
                            this.Schedule.OrgName = "";
                        }
                    },
                    'Schedule.ReserveDatetimeStr'(date) {
                        console.log('date', date)
                        this.DiagnosisMin = date;
                    },
                    GetReserveDateStr(val) {
                        this.Schedule.ReserveTime = "";
                    },
                    GetReserveTimeStr(val) {
                        if (val && this.Schedule.ReserveDatetimeStr) {
                            // 檢查時段是否已安排預約
                            const self = this;
                            $.ajax({
                                url: '/PlantDoctor/CheckDutyRecordNoCreate',
                                data: {
                                    Date: self.Schedule.ReserveDatetimeStr,
                                    Time: self.Schedule.ReserveTime
                                },
                                type: 'GET',
                                cache: false,
                                dataType: 'json',
                                success: function (data) {
                                    Swal.fire({
                                        icon: data.result ? "info" : "error",
                                        title: data.Msg
                                    });
                                    self.DisabledSubmit = !data.result;
                                }
                            });
                        }
                    },
                    center: {
                        handler(val) {
                            let lat = val[0], lng = val[1];
                            this.map.panTo(new L.LatLng(lat, lng));
                            if (this.marker) {
                                this.map.removeLayer(this.marker);
                            }
                            this.Schedule.FramLocation = `${lat},${lng}`;
                            this.marker = L.marker(val, {
                                title: this.promptStr,
                                opacity: 1.0
                            }).addTo(this.map);
                            // 加上 Popup
                            this.marker.bindPopup(this.promptStr).openPopup();
                            this.marker.bindTooltip(this.promptStr, {
                                direction: 'bottom', // right、left、top、bottom、center。default: auto
                                sticky: true, // true 跟著滑鼠移動。default: false
                                permanent: false, // 是滑鼠移過才出現，還是一直出現
                                opacity: 1.0
                            });
                        },
                        deep: true
                    }
                },
                computed: {
                    GetReserveDateStr() {
                        return this.Schedule.ReserveDatetimeStr;
                    },
                    GetReserveTimeStr() {
                        return this.Schedule.ReserveTime;
                    },
                    CropTypeList() {
                        if (!this.CropTypes) {
                            return [];
                        }
                        return this.CropTypes.map(c => {
                            return {
                                ID: c.ID,
                                Name: c.Name
                            }
                        });
                    },
                    CropList() {
                        let CropType = this.CropTypes.find(c => c.Name == this.Schedule.CropType);
                        if (CropType) {
                            return CropType.Crops.map(c => {
                                return {
                                    ID: c.ID,
                                    Name: c.Name
                                }
                            });
                        }
                        return [];
                    }
                },
                methods: {
                    async changeDistrict(val) {
                        const params = {
                            __RequestVerificationToken: this.token,
                            Zip: this.Schedule.OrgDistrict,
                            filterAll: true
                        }
                        const data = await $.ajax({ url: '/PlantDoctor/GetDistrictDoctor', data: params, type: 'GET', cache: false, dataType: 'json' });
                        this.DoctorList = data;
                    },
                    setDistrict() {
                        $('#hidDistrict').val($('#ddlDistrict option:selected').text());
                    },
                    changeCheckbox(name, key) {
                        let arr = this.Schedule[name] || [];
                        let i = arr.findIndex(a => a === key);

                        if (i < 0) {
                            arr.push(key);
                        } else {
                            arr.splice(i, 1);
                        }
                        console.log('changeCheckbox', key, i, arr);
                        this.$set(this.Schedule, name, arr);
                    },
                    getUserPosition() {
                        if (navigator.geolocation) {
                            navigator.geolocation.getCurrentPosition(this.successGPS, this.errorGPS);
                            return true;
                        }
                        return false;
                    },
                    // 跟使用者要位置
                    successGPS(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        this.promptStr = '所在位置';
                        this.center = [lat, lng];
                    },
                    errorGPS() {
                        this.center = this.defaultCenter;
                        window.alert('定位失敗! 請確認您的瀏覽器有提供定位功能，並允許取得位置。預設地點將為 高雄市農業局');
                    },
                    onMapClick(e) {
                        let lat = e.latlng.lat; // 緯度
                        let lng = e.latlng.lng; // 經度
                        this.promptStr = `點選位置<br />${lat},${lng}`;
                        this.center = [lat, lng];
                        this.popup
                            .setLatLng(e.latlng)
                            .setContent(`緯度：${lat}<br/>經度：${lng}`)
                            .openOn(this.map);
                    },
                    SearchAddress() {
                        const self = this;
                        var _addr = this.SearchLocation;
                        $.ajax({
                            url: '/PesticideSeller/GetAddrLocation',
                            data: {
                                addr: _addr
                            },
                            method: 'GET',
                            dataType: 'json',
                            success: function (response) {
                                if (response.result) {
                                    let LatLng = response.Msg.split(",");
                                    if (LatLng.length != 2) {
                                        return;
                                    }
                                    if (LatLng[0] && LatLng[1]) {
                                        //先把座標轉為WGS84
                                        let X = parseFloat(LatLng[0]);
                                        let Y = parseFloat(LatLng[1]);
                                        //LngLat格式
                                        if (X > 200 && Y > 200) {
                                            let LngLat = proj4("EPSG:3826", "EPSG:4326", [X, Y]);
                                            X = LngLat[0];
                                            Y = LngLat[1];
                                        }
                                        //轉成LatLng格式
                                        LatLng = [Y, X];
                                    }
                                    self.promptStr = `${_addr}<br />${LatLng[0]},${LatLng[1]}`;
                                    self.center = [LatLng[0], LatLng[1]];
                                }
                                else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: response.Msg
                                    });
                                }
                            },
                            complete: function () {
                                $('#syncLocation').attr('disabled', false).removeClass('disabled');
                            }
                        })
                    },
                    handleSubmit(e) {
                        const self = this;
                        this.validator = $('#form').validate({
                            rules: {
                                "Schedule.Inquiry": "required",
                                "Schedule.Name": "required",
                                "Schedule.Zip": "required",
                                "Schedule.CropType": "required",
                                "Schedule.CropName": "required",
                                "Schedule.Mobile": {
                                    required: true,
                                    pattern: "[0-9]{10}"
                                },
                                "Schedule.PlantingArea": {
                                    required: true,
                                    min: 0.1
                                },
                                "Schedule.ContactMethodArr": "required",
                                "Schedule.FarmingMethod": "required",
                                "Schedule.ContactMethod": "required",
                                "Schedule.Context": "required",
                                "Schedule.FarmingHistory": "required",
                                "Schedule.TransferDiagnosis": "required",
                                "Schedule.Status": "required",
                                "Schedule.OrgType": "required",
                                "Schedule.OrgDistrict": "required",
                                "Schedule.LoginID": "required",
                                "Schedule.OrgName": {
                                    required: {
                                        depends: function (element) {
                                            console.log(self.Schedule);
                                            return self.Schedule.OrgType != "None";
                                        }
                                    },
                                },
                            },
                            messages: {
                                "Schedule.Inquiry": "請選擇問診方式",
                                "Schedule.Name": "請輸入姓名",
                                "Schedule.Zip": "請選擇行政區",
                                "Schedule.CropType": "請選擇作物種類",
                                "Schedule.CropName": "請選擇作物",
                                "Schedule.Mobile": {
                                    required: "請輸入行動電話",
                                    pattern: "請輸入有效電話號碼"
                                },
                                "Schedule.PlantingArea": {
                                    required: "請輸入栽種面積",
                                    min: $.validator.format("請輸入有效栽種面積，最小 {0}")
                                },
                                "Schedule.ContactMethodArr": "請選擇聯繫方式",
                                "Schedule.FarmingMethod": "請選擇耕作方式",
                                "Schedule.ContactMethod": "請選擇聯繫管道",
                                "Schedule.Context": "請輸入諮詢內容",
                                "Schedule.FarmingHistory": "請選擇耕作歷史",
                                "Schedule.TransferDiagnosis": "請選擇後送診斷",
                                "Schedule.Status": "請選擇狀態",
                                "Schedule.OrgType": "請選擇輔導單位",
                                "Schedule.OrgDistrict": "請選擇輔導單位行政區",
                                "Schedule.LoginID": "請選擇植物醫師",
                                "Schedule.OrgName": "請選擇輔導單位名稱",
                            },
                            errorPlacement: function (error, element) {
                                console.log(error, element);
                                if ($(element).hasClass('form-check-input')) {
                                    error.appendTo($(element).parent().parent().parent());
                                } else {
                                    error.appendTo(element.parent());
                                }
                            },
                            submitHandler: function (form) {
                                if (self.Schedule.ReserveDatetimeStr > self.Schedule.DateDiagnosisStr && self.Schedule.DateDiagnosisStr) {
                                    Swal.fire({
                                        icon: "error",
                                        title: "預約日期晚於實際診斷日期無法保存"
                                    });
                                    return;
                                }
                                form.submit();
                            }
                        });
                    },
                },
                mounted() {
                    if (this.Schedule.ID == 0) {
                        this.$set(this.Schedule, 'ReserveDatetimeStr', this.today);
                    }

                    if (this.Schedule.ReserveTime) {
                        this.DisabledSubmit = false;
                    }

                    var _location = '@Model.Schedule.FramLocation';
                    let LatLng = _location.split(",");
                    if (LatLng.length == 2) {
                        let lat = LatLng[0]; // 緯度
                        let lng = LatLng[1]; // 經度
                        this.defaultCenter = [lat, lng];
                    }

                    // *** 放置地圖
                    this.map = L.map('map', {
                        center: this.defaultCenter, // 中心點座標
                        zoom: 15, // 0 - 18
                        attributionControl: true, // 是否秀出「leaflet」的貢獻標記
                        zoomControl: true, // 是否秀出 - + 按鈕
                    });
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://osm.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(this.map);
                    L.control.locate({
                        initialZoomLevel: 15
                    }).addTo(this.map);

                    if (LatLng.length == 2) {
                        let lat = LatLng[0]; // 緯度
                        let lng = LatLng[1]; // 經度
                        this.promptStr = `點選位置<br />${lat},${lng}`;
                        this.center = [lat, lng];
                        this.popup
                            .setLatLng(this.center)
                            .setContent(`緯度：${lat}<br/>經度：${lng}`)
                            .openOn(this.map);
                    }
                    // 監聽點擊事件
                    this.map.on('click', this.onMapClick);
                }
            });
        });
        function DelFile(id) {
            $('#' + id).html('');
        }
    </script>
}